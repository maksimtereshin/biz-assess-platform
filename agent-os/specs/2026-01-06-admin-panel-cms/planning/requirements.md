# Требования к спецификации: Админ-панель для управления контентом (CMS)

## Исходное описание

Полноценная система управления контентом для опросов, вопросов, ответов и категорий БЕЗ привлечения разработчика.

**Основные возможности:**
- CRUD опросов (Express/Full/отраслевые)
- Управление вопросами с различными типами
- Настройка категорий и весов для расчета результатов
- Визуальный редактор с предпросмотром

**Целевой результат:**
Администратор заходит в систему → конфигурирует опросы → изменения применяются автоматически в Telegram боте и WebApp без участия разработчика.

**Технологическая база:**
- AdminJS с интеграцией TypeORM
- Интеграция с существующей базой данных PostgreSQL
- Использование существующих TypeORM entities

## Обсуждение требований

### Первый раунд вопросов

**Q1:** Кто должен иметь доступ к админ-панели? Нужна ли система ролей (суперадмин/редактор/наблюдатель)?

**Ответ:** Расширяемый список админов, управляется через админку. По умолчанию 2 username (пользователь + Богданов). Управление списком админов через UI.

**Q2:** Какая структура данных у опроса? Я предполагаю: Survey → Categories → Subcategories → Questions → Answers (scale 1-10).

**Ответ:** Да, именно так: Survey → Categories → Subcategories → Questions → Answers (scale 1-10).

**Q3:** Нужно ли версионирование опросов? Если администратор изменит опрос, а пользователь уже начал проходить старую версию, не сломается ли логика?

**Ответ:** КРИТИЧНО — нужно версионирование. При редактировании опроса создается новая версия. Новые сессии используют новую версию, старые сессии продолжают использовать старую версию. Это предотвращает поломку логики для пользователей, проходящих опрос.

**Q4:** Как настраиваются веса для вопросов/категорий при расчете результатов? Фиксированные веса или настраиваемые через UI?

**Ответ:** Фиксированные, равные веса для вопросов.

**Q5:** Какой workflow публикации? Черновик → Публикация или изменения сразу видны пользователям?

**Ответ:** Workflow: Черновик → Публикация. Создание/редактирование в виде черновика (невидим пользователям). Публикация, когда готово (становится видимым).

**Q6:** Какие типы вопросов нужны изначально? Single choice, multiple choice, scale (1-10), text input?

**Ответ:** Только scale (1-10).

**Q7:** Нужны ли отраслевые опросы (строительство, медицина и т.д.) или только Express/Full?

**Ответ:** Отраслевые опросы — это вариации Express/Full на данный момент.

**Q8:** Что точно НЕ входит в первую версию админки? (например: управление пользователями, аналитика, настройка платежей, A/B тестирование)

**Ответ:** Вне scope v1:
- Управление пользователями/сессиями
- Аналитика/дашборды
- Управление платежами/отчетами
- A/B тестирование

### Существующий код для переиспользования

**Похожие функции, выявленные пользователем:**

Пользователь не указал существующие примеры админ UI.

**Существующие компоненты и логика:**

- **TypeORM Entities**: Существующие сущности в `backend/src/entities/`
  - `survey.entity.ts` — основная сущность опроса с JSONB структурой
  - `survey-session.entity.ts` — сессии опросов
  - `user.entity.ts` — пользователи
  - `answer.entity.ts` — ответы
  - `report.entity.ts` — отчеты
  - `payment.entity.ts` — платежи

- **Shared Types**: `shared/src/types/survey.types.ts`
  - `Survey`, `SurveyCategory`, `SurveySubcategory`, `SurveyQuestion`, `AnswerOption`
  - Полная типизация структуры опросов

- **Текущая модель данных**:
  - Survey.structure хранится как JSONB (PostgreSQL)
  - Иерархия: Category → Subcategory → Question → AnswerOption
  - Survey имеет тип (EXPRESS/FULL) и name

## Визуальные материалы

### Предоставленные файлы:

На основе проверки bash были найдены файлы визуализации в `planning/visuals/`:

- `highlevel-system-overview-sketch.png`: High-level системная архитектура (эскиз)
- `free-report-sketch.png`: Дизайн бесплатного отчета (эскиз)
- `paid-report-sketch.png`: Дизайн платного отчета (эскиз)

### Инсайты из визуальных материалов:

**Уровень детализации:** Все файлы являются эскизами (sketches), а не high-fidelity mockups.

**Замечание:** Визуальные материалы относятся к системной архитектуре и отчетам, **НЕ к админ-панели**. Конкретных UI-макетов для AdminJS интерфейса не предоставлено.

**Вывод:** AdminJS UI будет использовать стандартные компоненты AdminJS с минимальной кастомизацией. Фокус на функциональности, а не на custom UI.

## Резюме требований

### Функциональные требования

**FR-1: Управление списком администраторов**
- Расширяемый список администраторов (username)
- Управление через UI админ-панели
- По умолчанию: 2 администратора (пользователь + Богданов)
- Только администраторы имеют доступ к панели

**FR-2: CRUD операции для опросов**
- Создание нового опроса (Express/Full/отраслевые)
- Редактирование существующих опросов
- Удаление опросов (с предупреждением о влиянии на активные сессии)
- Просмотр списка всех опросов

**FR-3: Управление структурой опроса**
- Создание/редактирование/удаление категорий
- Создание/редактирование/удаление подкатегорий
- Создание/редактирование/удаление вопросов
- Настройка ответов (scale 1-10) с цветами и диапазонами

**FR-4: Версионирование опросов (КРИТИЧНО)**
- При редактировании опроса создается новая версия
- Новые сессии используют последнюю опубликованную версию
- Старые активные сессии продолжают использовать свою версию
- История версий доступна для просмотра
- Возможность откатиться к предыдущей версии

**FR-5: Workflow черновик → публикация**
- Создание опроса в статусе "Черновик" (draft)
- Редактирование черновика без влияния на пользователей
- Публикация опроса (publish) — становится доступным пользователям
- Снятие с публикации (unpublish) — скрыть опрос от новых пользователей
- Отображение статуса опроса в списке

**FR-6: Типы вопросов**
- **v1**: Только scale (1-10)
- **Будущее**: Single choice, multiple choice, text input (вне scope)

**FR-7: Визуальный предпросмотр**
- Предпросмотр структуры опроса в виде дерева
- Предпросмотр вопроса с ответами
- Валидация структуры перед публикацией

### Возможности переиспользования

**Существующие компоненты:**
- TypeORM entities (Survey, SurveySession, User)
- Shared types (полная типизация опросов)
- JSONB хранилище для структуры опросов

**Паттерны для следования:**
- Использование существующей модели Survey.structure (JSONB)
- Интеграция с TypeORM (AdminJS TypeORM adapter)
- Использование shared types для валидации

**Backend логика для изучения:**
- `backend/src/survey/` — модуль опросов
- `backend/src/entities/survey.entity.ts` — модель опроса
- Existing seeding logic для понимания структуры данных

### Границы scope

**В scope v1:**
- Аутентификация по Telegram username
- CRUD опросов (Express/Full/отраслевые)
- Управление категориями, подкатегориями, вопросами
- Версионирование опросов
- Workflow черновик → публикация
- Управление списком администраторов
- Визуальный предпросмотр структуры
- Валидация данных перед публикацией

**Вне scope v1:**
- Управление пользователями/сессиями
- Аналитика и дашборды
- Управление платежами
- Управление отчетами
- A/B тестирование вопросов
- Multiple choice / text input типы вопросов
- Настройка весов вопросов/категорий (фиксированные веса)
- Кастомизация UI AdminJS (используем стандартные компоненты)

### Технические требования

**TR-1: AdminJS интеграция**
- Установка AdminJS и AdminJS TypeORM adapter
- Интеграция с существующим NestJS приложением
- Использование существующих TypeORM entities
- Маршрут: `/admin` для доступа к панели

**TR-2: Аутентификация и авторизация**
- Проверка Telegram username из разрешенного списка
- Хранение списка администраторов в базе данных (новая таблица `admins`)
- Middleware для проверки доступа к `/admin`
- Session management для AdminJS

**TR-3: Модель данных — версионирование**

**Стратегия версионирования:**
- Добавить новую таблицу `survey_versions`
- Поля:
  - `id` (PK)
  - `survey_id` (FK to surveys)
  - `version` (integer, auto-increment per survey)
  - `name` (varchar)
  - `type` (enum: EXPRESS/FULL)
  - `structure` (JSONB)
  - `status` (enum: DRAFT, PUBLISHED, ARCHIVED)
  - `published_at` (timestamp, nullable)
  - `created_by` (FK to admins)
  - `created_at` (timestamp)

**Изменения в существующей модели:**
- `survey_sessions` добавить FK `survey_version_id` (вместо прямой связи с `survey_id`)
- Миграция данных: создать версию 1 для всех существующих опросов
- `surveys` таблица становится "мастер-записью" с указателем на `latest_published_version_id`

**TR-4: Модель данных — администраторы**

**Новая таблица `admins`:**
- `id` (PK)
- `telegram_username` (varchar, unique)
- `created_at` (timestamp)
- `created_by` (FK to admins, nullable для первого админа)

**TR-5: Валидация данных**
- Валидация структуры опроса перед сохранением
- Проверка уникальности ID категорий/подкатегорий/вопросов
- Валидация ответов (scale 1-10, цвета, диапазоны)
- Проверка обязательных полей (name, type, structure)

**TR-6: Custom компоненты AdminJS**
- Custom component для редактирования JSONB структуры (дерево категорий/вопросов)
- Custom component для предпросмотра опроса
- Custom action для публикации версии
- Custom action для создания новой версии из существующей

**TR-7: Интеграция с существующей системой**
- API endpoint `/api/surveys/:type/latest` должен возвращать последнюю опубликованную версию
- SurveySession должен хранить ссылку на конкретную версию опроса
- При старте новой сессии использовать `latest_published_version_id`

**TR-8: Безопасность**
- Только администраторы из таблицы `admins` имеют доступ
- Логирование всех действий администраторов
- Предотвращение удаления опроса с активными сессиями
- Soft delete для опросов и версий

**TR-9: Производительность**
- JSONB индексы для быстрого поиска по структуре
- Кеширование последней опубликованной версии
- Lazy loading для списка версий

### User Stories

**US-1: Как администратор, я хочу войти в админ-панель**
- **Дано:** Я являюсь администратором (мой username в списке)
- **Когда:** Я перехожу на `/admin` и авторизуюсь через Telegram
- **Тогда:** Я вижу главную страницу AdminJS с доступными ресурсами

**US-2: Как администратор, я хочу создать новый опрос**
- **Дано:** Я нахожусь в админ-панели
- **Когда:** Я создаю новый опрос с типом (Express/Full) и структурой
- **Тогда:** Опрос создается в статусе "Черновик" и недоступен пользователям

**US-3: Как администратор, я хочу редактировать опрос**
- **Дано:** Существует опубликованный опрос
- **Когда:** Я редактирую его структуру
- **Тогда:** Создается новая версия в статусе "Черновик", старая версия остается опубликованной

**US-4: Как администратор, я хочу опубликовать новую версию**
- **Дано:** Существует версия опроса в статусе "Черновик"
- **Когда:** Я публикую версию
- **Тогда:** Новые сессии используют эту версию, старые сессии продолжают использовать свою версию

**US-5: Как администратор, я хочу управлять списком администраторов**
- **Дано:** Я являюсь администратором
- **Когда:** Я добавляю/удаляю Telegram username в список
- **Тогда:** Пользователь получает/теряет доступ к админ-панели

**US-6: Как администратор, я хочу видеть предпросмотр опроса**
- **Дано:** Я редактирую опрос
- **Когда:** Я нажимаю "Предпросмотр"
- **Тогда:** Я вижу структуру опроса в виде дерева с категориями/вопросами

**US-7: Как администратор, я хочу видеть историю версий**
- **Дано:** Опрос имеет несколько версий
- **Когда:** Я открываю опрос
- **Тогда:** Я вижу список всех версий с датами публикации и статусами

**US-8: Как разработчик, я хочу, чтобы система предотвращала поломку активных сессий**
- **Дано:** Пользователь проходит опрос версии 1
- **Когда:** Администратор публикует версию 2
- **Тогда:** Пользователь продолжает видеть вопросы версии 1, новые пользователи видят версию 2

### Технические ограничения

**TC-1: Совместимость с существующей базой данных**
- Миграция должна быть обратимо совместимой
- Существующие данные должны быть сохранены
- Downtime при миграции минимален

**TC-2: Производительность JSONB**
- Структура опроса может быть большой (Full опрос ~100 вопросов)
- Индексы GIN для JSONB полей
- Валидация структуры перед сохранением

**TC-3: TypeScript типизация**
- Использование shared types для AdminJS компонентов
- Валидация соответствия JSONB структуры TypeScript интерфейсам
- Type-safe работа с AdminJS resources

**TC-4: NestJS интеграция**
- AdminJS как middleware в существующем NestJS приложении
- Использование существующего TypeORM connection
- Интеграция с существующим auth модулем

### Риски и mitigation

**Риск 1: Сложность версионирования**
- **Описание:** Версионирование может привести к усложнению логики и багам
- **Mitigation:** Тщательное тестирование, миграция данных в несколько этапов

**Риск 2: Производительность JSONB**
- **Описание:** Большие JSONB структуры могут замедлить работу
- **Mitigation:** Индексы, кеширование, lazy loading

**Риск 3: AdminJS кастомизация**
- **Описание:** AdminJS может не поддерживать все требуемые функции
- **Mitigation:** Использование custom components, fallback к стандартным компонентам

**Риск 4: Миграция данных**
- **Описание:** Существующие survey_sessions могут сломаться при добавлении версионирования
- **Mitigation:** Создать версию 1 для всех существующих опросов, обновить FK в миграции

### План интеграции с существующей системой

**Шаг 1: Подготовка**
- Изучить существующую структуру Survey entity
- Проанализировать использование опросов в коде
- Определить точки интеграции

**Шаг 2: Миграция базы данных**
- Создать таблицы `survey_versions` и `admins`
- Мигрировать существующие опросы в версии
- Обновить `survey_sessions` с FK на `survey_version_id`

**Шаг 3: Обновление бизнес-логики**
- Обновить `SurveyService` для работы с версиями
- Обновить `/api/surveys/:type/latest` endpoint
- Обновить логику старта сессии

**Шаг 4: Настройка AdminJS**
- Установить AdminJS и TypeORM adapter
- Создать AdminJS resources для Survey, SurveyVersion, Admin
- Настроить аутентификацию

**Шаг 5: Кастомные компоненты**
- Разработать редактор JSONB структуры
- Разработать компонент предпросмотра
- Разработать actions для версионирования

**Шаг 6: Тестирование**
- Unit тесты для версионирования
- Integration тесты для AdminJS endpoints
- E2E тесты для workflow черновик → публикация

**Шаг 7: Документация**
- Руководство администратора
- API документация
- Схема версионирования

### Зависимости

**Внешние библиотеки:**
- `adminjs` (^7.x)
- `@adminjs/nestjs` (^6.x)
- `@adminjs/typeorm` (^5.x)
- `express-session` (для AdminJS сессий)

**Внутренние зависимости:**
- TypeORM entities (Survey, SurveySession, User)
- Shared types (survey.types.ts)
- SurveyModule и SurveyService
- AuthModule для интеграции с Telegram

### Метрики успеха

**Функциональные метрики:**
- ✅ Администратор может создать опрос без разработчика
- ✅ Версионирование работает корректно (старые сессии не ломаются)
- ✅ Workflow черновик → публикация работает
- ✅ Управление администраторами работает

**Технические метрики:**
- ✅ Все миграции выполняются без ошибок
- ✅ JSONB валидация предотвращает некорректные данные
- ✅ Unit test coverage > 80% для новой логики
- ✅ API response time < 200ms для `/api/surveys/:type/latest`

**Бизнес метрики:**
- ✅ Время создания нового опроса: < 30 минут (vs недели с разработчиком)
- ✅ Количество созданных опросов за первый месяц: > 5
- ✅ Отсутствие багов из-за версионирования

## Дополнительные замечания

**Приоритет фичи:** Критический (Phase 2, Feature #1)

**Размер фичи:** XL — требует значительной разработки

**Целевая аудитория:**
- Владелец продукта
- Контент-менеджер
- Администратор системы

**Бизнес-ценность:**
- Независимость от разработчиков при создании контента
- Быстрое масштабирование продукта (новые опросы, отрасли)
- Снижение времени на изменения с недель до минут
- Возможность быстрой итерации и тестирования новых формулировок

**Следующие шаги:**
1. Создание технической спецификации (spec.md)
2. Разработка детального плана миграции базы данных
3. Создание прототипа AdminJS интеграции
4. Разработка custom компонентов для редактирования структуры
5. Тестирование версионирования на реальных данных
